<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GRASIAS</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
* {
box-sizing: border-box;
}

body {
font-family: 'Cairo', sans-serif;
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
margin: 0;
min-height: 100vh;
display: flex;
align-items: center;
justify-content: center;
direction: rtl;
padding: 20px;
}

.box {
background: white;
padding: 30px 25px;
border-radius: 20px;
box-shadow: 0 15px 50px rgba(0,0,0,0.2);
width: 100%;
max-width: 400px;
text-align: center;
animation: fadeIn 0.6s ease-in-out;
position: relative;
z-index: 1000;
visibility: visible !important;
opacity: 1 !important;
}

@keyframes fadeIn {
from {
opacity: 0;
transform: translateY(30px);
}
to {
opacity: 1;
transform: translateY(0);
}
}

h2 {
margin-bottom: 25px;
color: #4a5568;
font-weight: 600;
font-size: 24px;
}

input, button, textarea, select {
width: 100%;
padding: 15px;
border-radius: 12px;
margin-bottom: 15px;
font-size: 16px;
border: 2px solid #e2e8f0;
transition: all 0.3s ease;
font-family: 'Cairo', sans-serif;
}

input:focus, textarea:focus, select:focus {
border-color: #667eea;
outline: none;
box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

button {
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
color: white;
border: none;
cursor: pointer;
font-weight: 600;
transition: transform 0.2s ease;
}

button:hover {
transform: translateY(-2px);
box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
}

button:active {
transform: translateY(0);
}

.choice {
text-align: right;
margin: 25px 0;
}

.choice label {
display: flex;
align-items: center;
margin-bottom: 12px;
font-size: 16px;
cursor: pointer;
padding: 10px;
border-radius: 8px;
transition: background-color 0.2s ease;
}

.choice label:hover {
background-color: #f7fafc;
}

.choice input[type="radio"] {
width: auto;
margin-left: 10px;
margin-bottom: 0;
}

.declaration-box {
margin-top: 20px;
background: #f8f9fa;
padding: 20px;
border-radius: 12px;
text-align: right;
display: none;
border-right: 4px solid #667eea;
line-height: 1.6;
}

#mapPage {
display: none;
height: 100vh;
width: 100vw;
flex-direction: row;
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
}

#map {
width: 65%;
height: 100vh;
}

.sidebar {
width: 35%;
background: #fff;
padding: 30px;
overflow-y: auto;
box-shadow: -2px 0 10px rgba(0,0,0,0.1);
}

.sidebar h3 {
color: #4a5568;
margin-bottom: 20px;
font-size: 20px;
}

.sidebar label {
display: block;
margin-bottom: 8px;
font-weight: 600;
color: #2d3748;
}

#passengerPage, #driverPage, #mapPage {
display: none;
}

.file-input-wrapper {
position: relative;
margin-bottom: 15px;
}

.file-input-wrapper input[type="file"] {
opacity: 0;
position: absolute;
z-index: -1;
}

.file-input-label {
display: block;
padding: 15px;
background: #f8f9fa;
border: 2px dashed #cbd5e0;
border-radius: 12px;
text-align: center;
cursor: pointer;
transition: all 0.3s ease;
}

.file-input-label:hover {
border-color: #667eea;
background: #edf2f7;
}

.success-message {
background: #c6f6d5;
color: #22543d;
padding: 12px;
border-radius: 8px;
margin-bottom: 15px;
display: none;
}

.error-message {
background: #fed7d7;
color: #742a2a;
padding: 12px;
border-radius: 8px;
margin-bottom: 15px;
display: none;
}

.driver-card {
background: white;
border-radius: 12px;
padding: 15px;
margin-bottom: 15px;
box-shadow: 0 4px 12px rgba(0,0,0,0.1);
border: 2px solid transparent;
cursor: pointer;
transition: all 0.3s ease;
}

.driver-card:hover {
border-color: #667eea;
transform: translateY(-2px);
}

.driver-card.selected {
border-color: #48bb78;
background: #f0fff4;
}

.driver-info {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 10px;
}

.driver-name {
font-weight: 600;
color: #2d3748;
font-size: 16px;
}

.driver-distance {
background: #667eea;
color: white;
padding: 4px 8px;
border-radius: 6px;
font-size: 12px;
}

.car-info {
color: #718096;
font-size: 14px;
margin-bottom: 10px;
}

.driver-actions {
display: flex;
gap: 10px;
}

.action-btn {
flex: 1;
padding: 8px 12px;
border: none;
border-radius: 8px;
cursor: pointer;
font-size: 14px;
font-weight: 600;
transition: all 0.2s ease;
}

.call-btn {
background: #48bb78;
color: white;
}

.call-btn:hover {
background: #38a169;
}

.chat-btn {
background: #4299e1;
color: white;
}

.chat-btn:hover {
background: #3182ce;
}

.select-btn {
background: #667eea;
color: white;
}

.select-btn:hover {
background: #5a67d8;
}

.cancel-btn {
background: #e53e3e;
color: white;
}

.cancel-btn:hover {
background: #c53030;
}

.notification {
position: fixed;
top: 20px;
right: 20px;
background: white;
padding: 20px;
border-radius: 12px;
box-shadow: 0 8px 25px rgba(0,0,0,0.15);
border-right: 4px solid #667eea;
z-index: 1000;
max-width: 350px;
animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
from {
transform: translateX(100%);
opacity: 0;
}
to {
transform: translateX(0);
opacity: 1;
}
}

.notification-title {
font-weight: 600;
color: #2d3748;
margin-bottom: 10px;
}

.notification-content {
color: #4a5568;
margin-bottom: 15px;
line-height: 1.5;
}

.notification-actions {
display: flex;
gap: 10px;
}

.accept-btn {
background: #48bb78;
color: white;
border: none;
padding: 8px 16px;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
}

.reject-btn {
background: #e53e3e;
color: white;
border: none;
padding: 8px 16px;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
}

.chat-container {
position: fixed;
bottom: 20px;
right: 20px;
width: 300px;
height: 400px;
background: white;
border-radius: 12px;
box-shadow: 0 8px 25px rgba(0,0,0,0.15);
display: none;
flex-direction: column;
z-index: 1000;
}

.chat-header {
background: #667eea;
color: white;
padding: 15px;
border-radius: 12px 12px 0 0;
display: flex;
justify-content: space-between;
align-items: center;
}

.chat-messages {
flex: 1;
padding: 15px;
overflow-y: auto;
max-height: 250px;
}

.chat-input-container {
padding: 15px;
border-top: 1px solid #e2e8f0;
display: flex;
gap: 10px;
}

.chat-input {
flex: 1;
padding: 8px 12px;
border: 1px solid #e2e8f0;
border-radius: 8px;
margin: 0;
}

.send-btn {
background: #667eea;
color: white;
border: none;
padding: 8px 12px;
border-radius: 8px;
cursor: pointer;
margin: 0;
width: auto;
}

.message {
margin-bottom: 10px;
padding: 8px 12px;
border-radius: 8px;
max-width: 80%;
}

.message.sent {
background: #667eea;
color: white;
margin-left: auto;
text-align: left;
}

.message.received {
background: #f7fafc;
color: #2d3748;
margin-right: auto;
}

.trip-status {
background: #e6fffa;
border: 1px solid #81e6d9;
border-radius: 8px;
padding: 15px;
margin-bottom: 15px;
text-align: center;
}

.trip-status.active {
background: #f0fff4;
border-color: #9ae6b4;
}

.distance-calculator {
background: #f8f9fa;
border: 1px solid #e2e8f0;
border-radius: 8px;
padding: 15px;
margin-bottom: 15px;
}

.distance-input {
display: flex;
gap: 10px;
margin-bottom: 10px;
}

.distance-input input {
flex: 1;
margin: 0;
}

.price-display {
background: #667eea;
color: white;
padding: 10px;
border-radius: 8px;
text-align: center;
font-weight: 600;
font-size: 18px;
}

.driver-popup {
background: white;
padding: 15px;
border-radius: 8px;
box-shadow: 0 4px 12px rgba(0,0,0,0.15);
min-width: 200px;
}

.driver-popup h4 {
margin: 0 0 10px 0;
color: #2d3748;
font-size: 16px;
}

.driver-popup p {
margin: 5px 0;
color: #4a5568;
font-size: 14px;
}

.destination-input {
background: #f8f9fa;
border: 1px solid #e2e8f0;
border-radius: 8px;
padding: 15px;
margin-bottom: 15px;
}

.destination-input h4 {
margin: 0 0 10px 0;
color: #2d3748;
}

.destination-display {
background: #e6fffa;
border: 1px solid #81e6d9;
border-radius: 8px;
padding: 10px;
margin-bottom: 15px;
text-align: center;
font-weight: 600;
}

.map-layers {
background: #f8f9fa;
border: 1px solid #e2e8f0;
border-radius: 8px;
padding: 15px;
margin-bottom: 15px;
}

.map-layers h4 {
margin: 0 0 10px 0;
color: #2d3748;
}

.layer-option {
display: flex;
align-items: center;
margin-bottom: 8px;
}

.layer-option input[type="radio"] {
width: auto;
margin-left: 10px;
margin-bottom: 0;
}

.loading-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(255,255,255,0.9);
display: none;
justify-content: center;
align-items: center;
z-index: 9999;
}

.loading-spinner {
border: 4px solid #f3f3f3;
border-top: 4px solid #667eea;
border-radius: 50%;
width: 50px;
height: 50px;
animation: spin 1s linear infinite;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

@media (max-width: 768px) {
#mapPage {
flex-direction: column;
}

#map {
width: 100%;
height: 60vh;
}

.sidebar {
width: 100%;
height: 40vh;
padding: 20px;
}

.box {
margin: 10px;
padding: 20px;
}

.chat-container {
width: 90%;
right: 5%;
left: 5%;
}

.notification {
right: 10px;
left: 10px;
max-width: none;
}
}
</style>
</head>
<body>
<!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
<div id="loadingOverlay" class="loading-overlay">
<div class="loading-spinner"></div>
</div>

<!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div class="box" id="loginPage">
<h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ GRASIAS</h2>
<div class="choice">
<label>
<input type="radio" name="role" value="sayeq">
<span>ğŸš— Ø³Ø§Ø¦Ù‚</span>
</label>
<label>
<input type="radio" name="role" value="rakib">
<span>ğŸ§â€â™€ï¸ Ø±Ø§ÙƒØ¨</span>
</label>
</div>
<button onclick="signInWithGoogle()">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Google</button>
<button onclick="signInWithGoogleRedirect()" style="margin-top: 10px; background: #34a853;">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø©)</button>
</div>

<!-- ØµÙØ­Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø§ÙƒØ¨ -->
<div class="box" id="passengerPage">
<h2>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø§ÙƒØ¨</h2>
<div class="success-message" id="passengerSuccess"></div>
<div class="error-message" id="passengerError"></div>
<input type="text" id="passengerName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
<input type="tel" id="passengerPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø«Ø§Ù„: 0612345678)" required>
<div class="file-input-wrapper">
<input type="file" id="passengerIdCard" accept="image/*" />
<label for="passengerIdCard" class="file-input-label">
ğŸ“„ Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‡ÙˆÙŠØ©
</label>
</div>
<button onclick="submitPassengerInfo()">Ù…ØªØ§Ø¨Ø¹Ø© â¡ï¸</button>
</div>

<!-- ØµÙØ­Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ -->
<div class="box" id="driverPage">
<h2>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚</h2>
<div class="success-message" id="driverSuccess"></div>
<div class="error-message" id="driverError"></div>
<input type="text" id="driverName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
<input type="tel" id="driverPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø«Ø§Ù„: 0612345678)" required>
<input type="text" id="carType" placeholder="Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø© (Ù…Ø«Ø§Ù„: ØªÙˆÙŠÙˆØªØ§ ÙƒÙˆØ±ÙˆÙ„Ø§)" required>
<input type="text" id="carColor" placeholder="Ù„ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ø±Ø©" required>
<input type="text" id="plateNumber" placeholder="Ø±Ù‚Ù… Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©" required>
<div class="file-input-wrapper">
<input type="file" id="driverId" accept="image/*" required>
<label for="driverId" class="file-input-label">
ğŸ“„ Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‡ÙˆÙŠØ©
</label>
</div>
<div class="file-input-wrapper">
<input type="file" id="carCheck" accept="image/*" required>
<label for="carCheck" class="file-input-label">
ğŸ”§ Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„ØªÙ‚Ù†ÙŠ
</label>
</div>
<button onclick="showDeclaration()">ğŸ“œ Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù‡Ø¯</button>
<div class="declaration-box" id="declarationBox"></div>
<button onclick="startDriverMap()">Ù…ØªØ§Ø¨Ø¹Ø© â¡ï¸</button>
</div>

<!-- ØµÙØ­Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© -->
<div id="mapPage">
<div id="map"></div>
<div class="sidebar">
<div id="tripStatus" class="trip-status" style="display: none;">
<div id="tripStatusText"></div>
<button id="cancelTripBtn" class="cancel-btn" onclick="cancelTrip()" style="display: none; margin-top: 10px;">âŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
</div>
<h3 id="sidebarTitle">ğŸš— ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø©</h3>

<!-- Ø§Ø®ØªÙŠØ§Ø± Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø© -->
<div class="map-layers">
<h4>ğŸ—ºï¸ Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø©:</h4>
<div class="layer-option">
<input type="radio" name="mapLayer" value="osm" id="osmLayer" checked onchange="changeMapLayer()">
<label for="osmLayer">Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©</label>
</div>
<div class="layer-option">
<input type="radio" name="mapLayer" value="satellite" id="satelliteLayer" onchange="changeMapLayer()">
<label for="satelliteLayer">ØµÙˆØ± Ø§Ù„Ø£Ù‚Ù…Ø§Ø± Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©</label>
</div>
<div class="layer-option">
<input type="radio" name="mapLayer" value="terrain" id="terrainLayer" onchange="changeMapLayer()">
<label for="terrainLayer">Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªØ¶Ø§Ø±ÙŠØ³</label>
</div>
</div>

<!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø§ÙƒØ¨ -->
<div id="passengerContent">
<div id="nearbyDrivers">
<h4>Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ† Ø§Ù„Ù‚Ø±ÙŠØ¨ÙˆÙ†:</h4>
<div id="driversList"></div>
</div>
</div>

<!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³Ø§Ø¦Ù‚ -->
<div id="driverContent" style="display: none;">
<label>Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚:</label>
<select id="driverStatus" onchange="updateDriverStatus()">
<option value="available">Ù…ØªØ§Ø­</option>
<option value="busy">Ù…Ø´ØºÙˆÙ„</option>
<option value="offline">ØºÙŠØ± Ù…ØªØµÙ„</option>
</select>

<label>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©:</label>
<input type="number" id="availableSeats" min="1" max="8" value="4">

<!-- Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ¬Ù‡Ø© Ù„Ù„Ø³Ø§Ø¦Ù‚ -->
<div class="destination-input">
<h4>ğŸ¯ Ø§Ù„ÙˆØ¬Ù‡Ø©:</h4>
<input type="text" id="driverDestination" placeholder="Ø£Ø¯Ø®Ù„ ÙˆØ¬Ù‡ØªÙƒ..." onchange="updateDriverDestination()">
<div id="destinationDisplay" class="destination-display" style="display: none;"></div>
</div>

<label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚:</label>
<textarea id="driverNotes" placeholder="Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø±ÙƒØ§Ø¨..." style="height: 60px;"></textarea>

<!-- Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø³Ø§ÙØ© ÙˆØ§Ù„Ø«Ù…Ù† -->
<div class="distance-calculator">
<h4>Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø«Ù…Ù†:</h4>
<div class="distance-input">
<input type="number" id="distanceInput" placeholder="Ø§Ù„Ù…Ø³Ø§ÙØ© (ÙƒÙ…)" min="1" onchange="calculatePrice()">
</div>
<div id="priceDisplay" class="price-display" style="display: none;">
Ø§Ù„Ø«Ù…Ù†: <span id="calculatedPrice">0</span> Ø¯ÙŠÙ†Ø§Ø±
</div>
</div>
</div>

<button onclick="activateRide()" id="activateBtn">ğŸš— ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø©</button>
<button onclick="logout()" style="background: #e53e3e; margin-top: 10px;">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© -->
<div id="chatContainer" class="chat-container">
<div class="chat-header">
<span id="chatTitle">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</span>
<button onclick="closeChat()" style="background: none; border: none; color: white; cursor: pointer; padding: 0; margin: 0; width: auto;">âœ•</button>
</div>
<div id="chatMessages" class="chat-messages"></div>
<div class="chat-input-container">
<input type="text" id="chatInput" class="chat-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...">
<button onclick="sendMessage()" class="send-btn">Ø¥Ø±Ø³Ø§Ù„</button>
</div>
</div>

<!-- ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø§Øª Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, set, get, child, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
import { getAuth, signInWithPopup, signInWithRedirect, getRedirectResult, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
apiKey: "AIzaSyAekz29R9IwY1pygd4Mic5AX8XZ7A7Z4Fs",
authDomain: "grasias-d7830.firebaseapp.com",
databaseURL: "https://grasias-d7830-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId: "grasias-d7830",
storageBucket: "grasias-d7830.appspot.com",
messagingSenderId: "134413476604",
appId: "1:134413476604:web:ab1acfa69c025218cbad79",
measurementId: "G-6QBYM41CJ1"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø²ÙˆØ¯
provider.setCustomParameters({
prompt: 'select_account'
});

// Ø¬Ø¹Ù„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ§Ù„Ø¯ÙˆØ§Ù„ Ù…ØªØ§Ø­Ø© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹
window.currentUser = null;
window.currentRole = null;
window.db = db;
window.auth = auth;
window.ref = ref;
window.set = set;
window.get = get;
window.update = update;
window.push = push;
window.onValue = onValue;
window.remove = remove;

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
function showLoading() {
document.getElementById('loadingOverlay').style.display = 'flex';
}

function hideLoading() {
document.getElementById('loadingOverlay').style.display = 'none';
}

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Popup
window.signInWithGoogle = () => {
const roleInput = document.querySelector('input[name="role"]:checked');
if (!roleInput) {
alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆØ± Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
return;
}

window.currentRole = roleInput.value;
showLoading();

signInWithPopup(auth, provider)
.then((result) => {
console.log("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­:", result);
const user = result.user;
window.currentUser = user;
hideLoading();
handleUserLogin(user);
})
.catch((error) => {
hideLoading();
console.error("ØªÙØ§ØµÙŠÙ„ Ø®Ø·Ø£ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:", error);

if (error.code === 'auth/popup-closed-by-user') {
alert("ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
} else if (error.code === 'auth/popup-blocked') {
alert("ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø©.");
} else if (error.code === 'auth/cancelled-popup-request') {
alert("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.");
} else {
alert("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + error.message);
}
});
};

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Redirect (Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø©)
window.signInWithGoogleRedirect = () => {
const roleInput = document.querySelector('input[name="role"]:checked');
if (!roleInput) {
alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆØ± Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
return;
}

window.currentRole = roleInput.value;
localStorage.setItem('selectedRole', window.currentRole);
showLoading();

signInWithRedirect(auth, provider);
};

// Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
function handleUserLogin(user) {
    console.log("Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", user.uid);
    
    if (!user) {
        console.error("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„");
        return;
    }

    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡
    if (!auth.currentUser) {
        console.log("Ø§Ù†ØªØ¸Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...");
        setTimeout(() => handleUserLogin(user), 1000);
        return;
    }

    const userRef = ref(db, `users/${user.uid}`);
    
    get(userRef).then((snapshot) => {
        console.log("ØªÙ… Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­");
        
        if (snapshot.exists()) {
            const userData = snapshot.val();
            window.currentRole = userData.role;
            console.log("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø§Ù„Ø¯ÙˆØ±:", window.currentRole);
            
            showPage("mapPage");
            setTimeout(() => {
                loadMap(user.displayName);
                startLocationTracking();
            }, 100);
        } else {
            console.log("Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ØŒ Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª");
            
            const newUserData = {
                name: user.displayName,
                email: user.email,
                role: window.currentRole,
                createdAt: new Date().toISOString(),
                uid: user.uid
            };
            
            set(userRef, newUserData).then(() => {
                console.log("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­");
                
                if (window.currentRole === "rakib") {
                    showPage("passengerPage");
                } else {
                    showPage("driverPage");
                }
            }).catch((error) => {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", error);
                alert("Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: " + error.message);
            });
        }
    }).catch((error) => {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", error);
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
        const newUserData = {
            name: user.displayName,
            email: user.email,
            role: window.currentRole,
            createdAt: new Date().toISOString(),
            uid: user.uid
        };
        
        set(userRef, newUserData).then(() => {
            console.log("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­");
            
            if (window.currentRole === "rakib") {
                showPage("passengerPage");
            } else {
                showPage("driverPage");
            }
        }).catch((createError) => {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", createError);
            alert("Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: " + createError.message);
        });
    });
}


if (window.currentRole === "rakib") {
showPage("passengerPage");
} else {
showPage("driverPage");
}
}
}).catch((error) => {
console.error("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", error);
alert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
});
}

// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
onAuthStateChanged(auth, (user) => {
if (user) {
console.log("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„:", user);
window.currentUser = user;

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
const userRef = ref(db, `users/${user.uid}`);
get(userRef).then((snapshot) => {
if (snapshot.exists()) {
const userData = snapshot.val();
window.currentRole = userData.role;
if (document.getElementById('loginPage').style.display !== 'none') {
showPage("mapPage");
setTimeout(() => {
loadMap(user.displayName);
startLocationTracking();
}, 100);
}
}
});
} else {
console.log("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
window.currentUser = null;
showPage('loginPage');
}
hideLoading();
});

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ØªÙŠØ¬Ø© Redirect Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
getRedirectResult(auth).then((result) => {
if (result) {
const user = result.user;
window.currentUser = user;
window.currentRole = localStorage.getItem('selectedRole');
handleUserLogin(user);
}
}).catch((error) => {
console.error("Ø®Ø·Ø£ ÙÙŠ redirect:", error);
hideLoading();
});

// Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
window.addEventListener('load', () => {
setTimeout(() => {
hideLoading();
}, 1000);
});
</script>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script>
let currentMap = null;
let currentMarker = null;
let driversMarkers = [];
let passengersMarkers = [];
let currentLocation = null;
let selectedDriver = null;
let currentTrip = null;
let routeControl = null;
let currentChatPartner = null;
let currentTripRequestId = null;
let currentMapLayer = null;

// Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
const mapLayers = {
osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
attribution: 'Â© OpenStreetMap contributors'
}),
satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
attribution: 'Â© Esri'
}),
terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
attribution: 'Â© OpenTopoMap contributors'
})
};

// Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ù…Ø®ØµØµØ© Ù„Ù„Ø®Ø±ÙŠØ·Ø©
const driverIcon = L.divIcon({
html: 'ğŸš—',
iconSize: [30, 30],
className: 'custom-div-icon'
});

const passengerIcon = L.divIcon({
html: 'ğŸ§â€â™€ï¸',
iconSize: [30, 30],
className: 'custom-div-icon'
});

function showPage(id) {
["loginPage", "passengerPage", "driverPage", "mapPage"].forEach(p => {
document.getElementById(p).style.display = "none";
});
document.getElementById(id).style.display = id === "mapPage" ? "flex" : "block";
}

function showMessage(type, message, pagePrefix = '') {
const successEl = document.getElementById(pagePrefix + 'Success');
const errorEl = document.getElementById(pagePrefix + 'Error');

if (successEl && errorEl) {
if (type === 'success') {
successEl.textContent = message;
successEl.style.display = 'block';
errorEl.style.display = 'none';
} else {
errorEl.textContent = message;
errorEl.style.display = 'block';
successEl.style.display = 'none';
}

setTimeout(() => {
successEl.style.display = 'none';
errorEl.style.display = 'none';
}, 5000);
}
}

// ØªØºÙŠÙŠØ± Ø·Ø¨Ù‚Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©
function changeMapLayer() {
const selectedLayer = document.querySelector('input[name="mapLayer"]:checked');
if (!selectedLayer || !currentMap) return;

const layerValue = selectedLayer.value;

if (currentMapLayer) {
currentMap.removeLayer(currentMapLayer);
}
currentMapLayer = mapLayers[layerValue];
currentMapLayer.addTo(currentMap);
}

// ØªØ­Ø¯ÙŠØ« ÙˆØ¬Ù‡Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚
function updateDriverDestination() {
const destinationInput = document.getElementById('driverDestination');
const destinationDisplay = document.getElementById('destinationDisplay');

if (!destinationInput || !destinationDisplay) return;

const destination = destinationInput.value;
const driverData = JSON.parse(localStorage.getItem('driverData') || '{}');
driverData.destination = destination;
localStorage.setItem('driverData', JSON.stringify(driverData));

if (destination.trim()) {
destinationDisplay.textContent = `ğŸ¯ Ø§Ù„ÙˆØ¬Ù‡Ø©: ${destination}`;
destinationDisplay.style.display = 'block';
} else {
destinationDisplay.style.display = 'none';
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ¬Ù‡Ø© ÙÙŠ Firebase
if (window.currentUser) {
window.update(window.ref(window.db, `locations/${window.currentUser.uid}`), {
destination: destination
});
}
}

// Ø­Ø³Ø§Ø¨ Ø«Ù…Ù† Ø§Ù„Ù…Ø³Ø§ÙØ©
function calculatePrice() {
const distanceInput = document.getElementById('distanceInput');
const priceDisplay = document.getElementById('priceDisplay');
const calculatedPrice = document.getElementById('calculatedPrice');

if (!distanceInput || !priceDisplay || !calculatedPrice) return;

const distance = parseFloat(distanceInput.value);
if (!distance || distance <= 0) {
priceDisplay.style.display = 'none';
return;
}

let totalPrice = 0;

if (distance <= 20) {
totalPrice = distance * 10;
} else if (distance <= 50) {
totalPrice = (20 * 10) + ((distance - 20) * 5);
} else {
totalPrice = (20 * 10) + (30 * 5) + ((distance - 50) * 2);
}

calculatedPrice.textContent = totalPrice;
priceDisplay.style.display = 'block';
}

function loadMap(userName) {
if (currentMap) {
currentMap.remove();
}

const mapElement = document.getElementById('map');
if (!mapElement) return;

currentMap = L.map('map').setView([28.0339, 1.6596], 6);

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
currentMapLayer = mapLayers.osm;
currentMapLayer.addTo(currentMap);

// ØªØ®ØµÙŠØµ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
const passengerContent = document.getElementById('passengerContent');
const driverContent = document.getElementById('driverContent');
const sidebarTitle = document.getElementById('sidebarTitle');
const activateBtn = document.getElementById('activateBtn');

if (window.currentRole === 'rakib') {
if (passengerContent) passengerContent.style.display = 'block';
if (driverContent) driverContent.style.display = 'none';
if (sidebarTitle) sidebarTitle.textContent = 'ğŸ§â€â™€ï¸ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚';
if (activateBtn) activateBtn.textContent = 'ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚';
} else {
if (passengerContent) passengerContent.style.display = 'none';
if (driverContent) driverContent.style.display = 'block';
if (sidebarTitle) sidebarTitle.textContent = 'ğŸš— Ù„ÙˆØ­Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚';
if (activateBtn) activateBtn.textContent = 'ğŸš— ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©';
}

if (navigator.geolocation) {
navigator.geolocation.getCurrentPosition(position => {
const lat = position.coords.latitude;
const lng = position.coords.longitude;
currentLocation = { lat, lng };

currentMap.setView([lat, lng], 14);

if (currentMarker) {
currentMap.removeLayer(currentMarker);
}

const icon = window.currentRole === 'rakib' ? passengerIcon : driverIcon;
currentMarker = L.marker([lat, lng], { icon }).addTo(currentMap)
.bindPopup(`ğŸ“ ${userName}`)
.openPopup();

// Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹
startLocationTracking();
}, (error) => {
console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹:", error);
alert("âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹.");
});
} else {
alert("âš ï¸ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.");
}
}

// ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
function startLocationTracking() {
if (!window.currentUser) return;

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙƒÙ„ 10 Ø«ÙˆØ§Ù†
setInterval(() => {
if (navigator.geolocation && currentLocation) {
navigator.geolocation.getCurrentPosition(position => {
const driverStatusElement = document.getElementById('driverStatus');
const availableSeatsElement = document.getElementById('availableSeats');
const driverNotesElement = document.getElementById('driverNotes');

const newLocation = {
lat: position.coords.latitude,
lng: position.coords.longitude,
role: window.currentRole,
name: window.currentUser.displayName,
timestamp: Date.now(),
status: window.currentRole === 'sayeq' ? (driverStatusElement?.value || 'available') : 'active'
};

// Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø³Ø§Ø¦Ù‚Ø§Ù‹
if (window.currentRole === 'sayeq') {
const driverData = JSON.parse(localStorage.getItem('driverData') || '{}');
newLocation.phone = driverData.phone || '';
newLocation.carType = driverData.carType || '';
newLocation.carColor = driverData.carColor || '';
newLocation.plateNumber = driverData.plateNumber || '';
newLocation.availableSeats = availableSeatsElement?.value || 4;
newLocation.notes = driverNotesElement?.value || '';
newLocation.destination = driverData.destination || '';
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Firebase
window.set(window.ref(window.db, `locations/${window.currentUser.uid}`), newLocation);

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ù„ÙŠ
currentLocation = { lat: newLocation.lat, lng: newLocation.lng };

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
if (currentMarker) {
currentMarker.setLatLng([newLocation.lat, newLocation.lng]);
}
});
}
}, 10000);

// Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†
if (window.currentRole === 'rakib') {
watchDrivers();
} else {
watchPassengers();
}

// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø§Øª
watchTripRequests();
}

// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù„Ù„Ø±ÙƒØ§Ø¨
function watchDrivers() {
const driversRef = window.ref(window.db, 'locations');
window.onValue(driversRef, (snapshot) => {
const locations = snapshot.val();
updateDriversOnMap(locations);
updateDriversList(locations);
});
}

// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±ÙƒØ§Ø¨ Ù„Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†
function watchPassengers() {
const passengersRef = window.ref(window.db, 'locations');
window.onValue(passengersRef, (snapshot) => {
const locations = snapshot.val();
updatePassengersOnMap(locations);
});
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
function updateDriversOnMap(locations) {
// Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
driversMarkers.forEach(marker => {
if (currentMap) currentMap.removeLayer(marker);
});
driversMarkers = [];

if (!locations || !currentMap) return;

Object.keys(locations).forEach(userId => {
const location = locations[userId];
if (location.role === 'sayeq' && location.status === 'available' && userId !== window.currentUser?.uid) {
const marker = L.marker([location.lat, location.lng], { icon: driverIcon })
.addTo(currentMap);

// Ø¥Ù†Ø´Ø§Ø¡ popup Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„ÙƒØ§Ù…Ù„Ø©
const popupContent = `
<div class="driver-popup">
<h4>ğŸš— ${location.name}</h4>
<p><strong>ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${location.phone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</p>
<p><strong>ğŸš™ Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</strong> ${location.carType || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
<p><strong>ğŸ¨ Ù„ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</strong> ${location.carColor || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
<p><strong>ğŸ”¢ Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©:</strong> ${location.plateNumber || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</p>
<p><strong>ğŸ’º Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©:</strong> ${location.availableSeats || 4}</p>
${location.destination ? `<p><strong>ğŸ¯ Ø§Ù„ÙˆØ¬Ù‡Ø©:</strong> ${location.destination}</p>` : ''}
${location.notes ? `<p><strong>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${location.notes}</p>` : ''}
</div>
`;

marker.bindPopup(popupContent);
marker.userId = userId;
driversMarkers.push(marker);
}
});
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ÙƒØ§Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
function updatePassengersOnMap(locations) {
// Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
passengersMarkers.forEach(marker => {
if (currentMap) currentMap.removeLayer(marker);
});
passengersMarkers = [];

if (!locations || !currentMap) return;

Object.keys(locations).forEach(userId => {
const location = locations[userId];
if (location.role === 'rakib' && userId !== window.currentUser?.uid) {
const marker = L.marker([location.lat, location.lng], { icon: passengerIcon })
.addTo(currentMap);

const popupContent = `
<div class="driver-popup">
<h4>ğŸ§â€â™€ï¸ ${location.name}</h4>
<p><strong>ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹:</strong> Ø±Ø§ÙƒØ¨ ÙŠØ¨Ø­Ø« Ø¹Ù† Ø±Ø­Ù„Ø©</p>
</div>
`;

marker.bindPopup(popupContent);
marker.userId = userId;
passengersMarkers.push(marker);
}
});
}

// ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†
function updateDriversList(locations) {
const driversList = document.getElementById('driversList');
if (!driversList) return;

driversList.innerHTML = '';

if (!locations || !currentLocation) return;

const availableDrivers = [];

Object.keys(locations).forEach(userId => {
const location = locations[userId];
if (location.role === 'sayeq' && location.status === 'available' && userId !== window.currentUser?.uid) {
const distance = calculateDistance(currentLocation.lat, currentLocation.lng, location.lat, location.lng);
availableDrivers.push({ ...location, userId, distance });
}
});

// ØªØ±ØªÙŠØ¨ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©
availableDrivers.sort((a, b) => a.distance - b.distance);

availableDrivers.forEach(driver => {
const driverCard = document.createElement('div');
driverCard.className = 'driver-card';
driverCard.innerHTML = `
<div class="driver-info">
<span class="driver-name">ğŸš— ${driver.name}</span>
<span class="driver-distance">${driver.distance.toFixed(1)} ÙƒÙ…</span>
</div>
<div class="car-info">
ğŸš™ ${driver.carType || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} - ğŸ¨ ${driver.carColor || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
<br>ğŸ’º ${driver.availableSeats || 4} Ù…Ù‚Ø§Ø¹Ø¯ Ù…ØªØ§Ø­Ø©
${driver.destination ? `<br>ğŸ¯ Ø§Ù„ÙˆØ¬Ù‡Ø©: ${driver.destination}` : ''}
</div>
<div class="driver-actions">
<button class="action-btn call-btn" onclick="callDriver('${driver.phone}')">ğŸ“ Ø§ØªØµØ§Ù„</button>
<button class="action-btn chat-btn" onclick="startChat('${driver.userId}', '${driver.name}')">ğŸ’¬ Ø¯Ø±Ø¯Ø´Ø©</button>
<button class="action-btn select-btn" onclick="selectDriver('${driver.userId}')">âœ… Ø§Ø®ØªÙŠØ§Ø±</button>
</div>
`;
driversList.appendChild(driverCard);
});

if (availableDrivers.length === 0) {
driversList.innerHTML = '<p style="text-align: center; color: #718096;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø§Ø¦Ù‚ÙˆÙ† Ù…ØªØ§Ø­ÙˆÙ† ÙÙŠ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</p>';
}
}

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ù†Ù‚Ø·ØªÙŠÙ†
function calculateDistance(lat1, lng1, lat2, lng2) {
const R = 6371; // Ù†ØµÙ Ù‚Ø·Ø± Ø§Ù„Ø£Ø±Ø¶ Ø¨Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±
const dLat = (lat2 - lat1) * Math.PI / 180;
const dLng = (lng2 - lng1) * Math.PI / 180;
const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
Math.sin(dLng/2) * Math.sin(dLng/2);
const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
return R * c;
}

// Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø§Ø¦Ù‚
function callDriver(phone) {
if (phone && phone !== 'ØºÙŠØ± Ù…ØªÙˆÙØ±') {
window.open(`tel:${phone}`, '_self');
} else {
alert('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± Ù…ØªÙˆÙØ±');
}
}

// Ø¨Ø¯Ø¡ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
function startChat(userId, userName) {
currentChatPartner = { userId, userName };
const chatTitle = document.getElementById('chatTitle');
const chatContainer = document.getElementById('chatContainer');
if (chatTitle) chatTitle.textContent = `Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ ${userName}`;
if (chatContainer) chatContainer.style.display = 'flex';
loadChatMessages(userId);
}

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
function closeChat() {
const chatContainer = document.getElementById('chatContainer');
if (chatContainer) chatContainer.style.display = 'none';
currentChatPartner = null;
}

// ØªØ­Ù…ÙŠÙ„ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
function loadChatMessages(partnerId) {
const chatId = [window.currentUser.uid, partnerId].sort().join('_');
const messagesRef = window.ref(window.db, `chats/${chatId}/messages`);

window.onValue(messagesRef, (snapshot) => {
const messages = snapshot.val();
const chatMessages = document.getElementById('chatMessages');
if (!chatMessages) return;

chatMessages.innerHTML = '';

if (messages) {
Object.keys(messages).forEach(messageId => {
const message = messages[messageId];
const messageDiv = document.createElement('div');
messageDiv.className = `message ${message.senderId === window.currentUser.uid ? 'sent' : 'received'}`;
messageDiv.textContent = message.text;
chatMessages.appendChild(messageDiv);
});
chatMessages.scrollTop = chatMessages.scrollHeight;
}
});
}

// Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
function sendMessage() {
const chatInput = document.getElementById('chatInput');
if (!chatInput || !currentChatPartner) return;

const messageText = chatInput.value.trim();
if (!messageText) return;

const chatId = [window.currentUser.uid, currentChatPartner.userId].sort().join('_');
const messagesRef = window.ref(window.db, `chats/${chatId}/messages`);

window.push(messagesRef, {
text: messageText,
senderId: window.currentUser.uid,
senderName: window.currentUser.displayName,
timestamp: Date.now()
});

chatInput.value = '';
}

// Ø§Ø®ØªÙŠØ§Ø± Ø³Ø§Ø¦Ù‚
function selectDriver(driverId) {
selectedDriver = driverId;

// Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ù„Ù„Ø³Ø§Ø¦Ù‚
const tripRequest = {
passengerId: window.currentUser.uid,
passengerName: window.currentUser.displayName,
driverId: driverId,
passengerLocation: currentLocation,
status: 'pending',
timestamp: Date.now()
};

window.push(window.ref(window.db, 'tripRequests'), tripRequest)
.then((ref) => {
currentTripRequestId = ref.key;
showNotification('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø©', 'ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚...', 'info');
});
}

// Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©
function cancelTrip() {
if (currentTripRequestId) {
// Ø¥Ù„ØºØ§Ø¡ Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø©
window.update(window.ref(window.db, `tripRequests/${currentTripRequestId}`), {
status: 'cancelled',
cancelledAt: Date.now(),
cancelledBy: window.currentUser.uid
});

// Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø± Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©
if (routeControl && currentMap) {
currentMap.removeControl(routeControl);
routeControl = null;
}

// Ø¥Ø®ÙØ§Ø¡ Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø©
const tripStatus = document.getElementById('tripStatus');
const cancelTripBtn = document.getElementById('cancelTripBtn');
if (tripStatus) tripStatus.style.display = 'none';
if (cancelTripBtn) cancelTripBtn.style.display = 'none';

currentTripRequestId = null;
selectedDriver = null;

showNotification('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©', 'ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚ Ø¢Ø®Ø±', 'info');
}
}

// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø§Øª
function watchTripRequests() {
const requestsRef = window.ref(window.db, 'tripRequests');
window.onValue(requestsRef, (snapshot) => {
const requests = snapshot.val();
if (!requests) return;

Object.keys(requests).forEach(requestId => {
const request = requests[requestId];

// Ù„Ù„Ø³Ø§Ø¦Ù‚: Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
if (window.currentRole === 'sayeq' && request.driverId === window.currentUser.uid && request.status === 'pending') {
showTripRequestNotification(request, requestId);
}

// Ù„Ù„Ø±Ø§ÙƒØ¨: Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
if (window.currentRole === 'rakib' && request.passengerId === window.currentUser.uid) {
updateTripStatus(request, requestId);
}
});
});
}

// Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø© Ù„Ù„Ø³Ø§Ø¦Ù‚
function showTripRequestNotification(request, requestId) {
// ØªØ¬Ù†Ø¨ Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…ØªÙƒØ±Ø±Ø©
if (document.querySelector(`[data-request-id="${requestId}"]`)) return;

const notification = document.createElement('div');
notification.className = 'notification';
notification.setAttribute('data-request-id', requestId);
notification.innerHTML = `
<div class="notification-title">ğŸš— Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯</div>
<div class="notification-content">
Ø§Ù„Ø±Ø§ÙƒØ¨: ${request.passengerName}<br>
Ø§Ù„Ù…Ø³Ø§ÙØ©: ${calculateDistance(currentLocation.lat, currentLocation.lng, request.passengerLocation.lat, request.passengerLocation.lng).toFixed(1)} ÙƒÙ…
</div>
<div class="notification-actions">
<button class="accept-btn" onclick="acceptTrip('${requestId}')">Ù‚Ø¨ÙˆÙ„</button>
<button class="reject-btn" onclick="rejectTrip('${requestId}')">Ø±ÙØ¶</button>
</div>
`;
document.body.appendChild(notification);

// Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¹Ø¯ 30 Ø«Ø§Ù†ÙŠØ©
setTimeout(() => {
if (notification.parentNode) {
notification.parentNode.removeChild(notification);
}
}, 30000);
}

// Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©
function acceptTrip(requestId) {
window.update(window.ref(window.db, `tripRequests/${requestId}`), {
status: 'accepted',
acceptedAt: Date.now()
});

// Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
const notification = document.querySelector(`[data-request-id="${requestId}"]`);
if (notification && notification.parentNode) {
notification.parentNode.removeChild(notification);
}

showNotification('ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©', 'ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø±Ø§ÙƒØ¨', 'success');

// ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¥Ù„Ù‰ Ù…Ø´ØºÙˆÙ„
const driverStatus = document.getElementById('driverStatus');
if (driverStatus) {
driverStatus.value = 'busy';
updateDriverStatus();
}
}

// Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©
function rejectTrip(requestId) {
window.update(window.ref(window.db, `tripRequests/${requestId}`), {
status: 'rejected',
rejectedAt: Date.now()
});

// Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
const notification = document.querySelector(`[data-request-id="${requestId}"]`);
if (notification && notification.parentNode) {
notification.parentNode.removeChild(notification);
}
}

// ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø© Ù„Ù„Ø±Ø§ÙƒØ¨
function updateTripStatus(request, requestId) {
const statusDiv = document.getElementById('tripStatus');
const statusText = document.getElementById('tripStatusText');
const cancelBtn = document.getElementById('cancelTripBtn');

if (!statusDiv || !statusText || !cancelBtn) return;

if (request.status === 'pending') {
statusDiv.style.display = 'block';
statusText.textContent = 'â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚...';
statusDiv.className = 'trip-status';
cancelBtn.style.display = 'block';
currentTripRequestId = requestId;
} else if (request.status === 'accepted') {
statusDiv.style.display = 'block';
statusText.textContent = 'âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚';
statusDiv.className = 'trip-status active';
cancelBtn.style.display = 'block';
currentTripRequestId = requestId;

// Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¦Ù‚
drawRouteToDriver(request.driverId);
} else if (request.status === 'rejected') {
statusDiv.style.display = 'block';
statusText.textContent = 'âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚ Ø¢Ø®Ø±';
statusDiv.className = 'trip-status';
cancelBtn.style.display = 'none';
currentTripRequestId = null;
} else if (request.status === 'cancelled') {
statusDiv.style.display = 'none';
cancelBtn.style.display = 'none';
currentTripRequestId = null;
}
}

// Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¦Ù‚
function drawRouteToDriver(driverId) {
const driversRef = window.ref(window.db, `locations/${driverId}`);
window.get(driversRef).then((snapshot) => {
if (snapshot.exists() && currentMap) {
const driverLocation = snapshot.val();

// Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ù† ÙˆØ¬Ø¯
if (routeControl) {
currentMap.removeControl(routeControl);
}

// Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
routeControl = L.Routing.control({
waypoints: [
L.latLng(currentLocation.lat, currentLocation.lng),
L.latLng(driverLocation.lat, driverLocation.lng)
],
routeWhileDragging: false,
addWaypoints: false,
createMarker: function() { return null; }, // Ù„Ø§ Ù†Ø±ÙŠØ¯ Ø¹Ù„Ø§Ù…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
lineOptions: {
styles: [{ color: '#667eea', weight: 4, opacity: 0.7 }]
}
}).addTo(currentMap);
}
});
}

// Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±
function showNotification(title, content, type) {
const notification = document.createElement('div');
notification.className = 'notification';
notification.innerHTML = `
<div class="notification-title">${title}</div>
<div class="notification-content">${content}</div>
`;
document.body.appendChild(notification);

setTimeout(() => {
if (notification.parentNode) {
notification.parentNode.removeChild(notification);
}
}, 5000);
}

// ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚
function updateDriverStatus() {
const driverStatus = document.getElementById('driverStatus');
if (driverStatus && window.currentUser && currentLocation) {
const status = driverStatus.value;
window.update(window.ref(window.db, `locations/${window.currentUser.uid}`), {
status: status
});
}
}

// ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø©
function activateRide() {
if (window.currentRole === 'rakib') {
// Ù„Ù„Ø±Ø§ÙƒØ¨: Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚
showMessage('success', 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ†...');
} else {
// Ù„Ù„Ø³Ø§Ø¦Ù‚: ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©
const driverStatus = document.getElementById('driverStatus');
if (driverStatus) {
const status = driverStatus.value;
if (status === 'available') {
showMessage('success', 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø®Ø¯Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ù†Ø¬Ø§Ø­!');
} else {
showMessage('error', 'ÙŠØ¬Ø¨ ØªØºÙŠÙŠØ± Ø­Ø§Ù„ØªÙƒ Ø¥Ù„Ù‰ "Ù…ØªØ§Ø­" Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©');
}
}
}
}

// Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø§ÙƒØ¨
function submitPassengerInfo() {
const nameInput = document.getElementById('passengerName');
const phoneInput = document.getElementById('passengerPhone');
const idCardInput = document.getElementById('passengerIdCard');

if (!nameInput || !phoneInput || !idCardInput) return;

const name = nameInput.value;
const phone = phoneInput.value;
const idCard = idCardInput.files[0];

if (!name || !phone || !idCard) {
showMessage('error', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'passenger');
return;
}

// Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
localStorage.setItem('passengerData', JSON.stringify({ name, phone }));

// Ø­ÙØ¸ ÙÙŠ Firebase
window.update(window.ref(window.db, `users/${window.currentUser.uid}`), {
name: name,
phone: phone,
profileComplete: true
}).then(() => {
showMessage('success', 'ØªÙ… Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­!', 'passenger');
setTimeout(() => {
showPage("mapPage");
loadMap(name);
startLocationTracking();
}, 2000);
}).catch((error) => {
console.error("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
showMessage('error', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'passenger');
});
}

// Ø¨Ø¯Ø¡ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚
function startDriverMap() {
const nameInput = document.getElementById('driverName');
const phoneInput = document.getElementById('driverPhone');
const carTypeInput = document.getElementById('carType');
const carColorInput = document.getElementById('carColor');
const plateNumberInput = document.getElementById('plateNumber');

if (!nameInput || !phoneInput || !carTypeInput || !carColorInput || !plateNumberInput) return;

const name = nameInput.value;
const phone = phoneInput.value;
const carType = carTypeInput.value;
const carColor = carColorInput.value;
const plateNumber = plateNumberInput.value;

if (!name || !phone || !carType || !carColor || !plateNumber) {
showMessage('error', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'driver');
return;
}

// Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
localStorage.setItem('driverData', JSON.stringify({
name, phone, carType, carColor, plateNumber
}));

// Ø­ÙØ¸ ÙÙŠ Firebase
window.update(window.ref(window.db, `users/${window.currentUser.uid}`), {
name: name,
phone: phone,
carType: carType,
carColor: carColor,
plateNumber: plateNumber,
profileComplete: true
}).then(() => {
showMessage('success', 'ØªÙ… Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­!', 'driver');
setTimeout(() => {
showPage("mapPage");
loadMap(name);
startLocationTracking();
}, 2000);
}).catch((error) => {
console.error("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
showMessage('error', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'driver');
});
}

// Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù‡Ø¯
function showDeclaration() {
const declarationBox = document.getElementById('declarationBox');
if (!declarationBox) return;

declarationBox.innerHTML = `
<h4>ğŸ“œ ØªØ¹Ù‡Ø¯ Ø§Ù„Ø³Ø§Ø¦Ù‚</h4>
<p>Ø£ØªØ¹Ù‡Ø¯ Ø¨Ø£Ù†:</p>
<ul style="text-align: right; margin: 15px 0;">
<li>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© ØµØ­ÙŠØ­Ø© ÙˆØ¯Ù‚ÙŠÙ‚Ø©</li>
<li>Ø³ÙŠØ§Ø±ØªÙŠ ÙÙŠ Ø­Ø§Ù„Ø© Ø¬ÙŠØ¯Ø© ÙˆØµØ§Ù„Ø­Ø© Ù„Ù„Ù‚ÙŠØ§Ø¯Ø©</li>
<li>Ø£Ø­Ù…Ù„ Ø±Ø®ØµØ© Ù‚ÙŠØ§Ø¯Ø© Ø³Ø§Ø±ÙŠØ© Ø§Ù„Ù…ÙØ¹ÙˆÙ„</li>
<li>Ø³Ø£ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø±ÙƒØ§Ø¨ Ø¨Ø£Ø¯Ø¨ ÙˆØ§Ø­ØªØ±Ø§Ù…</li>
<li>Ø³Ø£Ù„ØªØ²Ù… Ø¨Ù‚ÙˆØ§Ù†ÙŠÙ† Ø§Ù„Ù…Ø±ÙˆØ± ÙˆÙ‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø³Ù„Ø§Ù…Ø©</li>
<li>Ø³Ø£Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ù†Ø¸Ø§ÙØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø©</li>
<li>Ù„Ù† Ø£Ø·Ù„Ø¨ Ø£Ø¬Ø±Ø© Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§</li>
</ul>
<p style="color: #e53e3e; font-weight: 600;">
âš ï¸ Ø£Ø¯Ø±Ùƒ Ø£Ù† Ù…Ø®Ø§Ù„ÙØ© Ù‡Ø°Ø§ Ø§Ù„ØªØ¹Ù‡Ø¯ Ù‚Ø¯ ÙŠØ¤Ø¯ÙŠ Ø¥Ù„Ù‰ Ø¥ÙŠÙ‚Ø§Ù Ø­Ø³Ø§Ø¨ÙŠ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
</p>
`;
declarationBox.style.display = 'block';
}

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
function logout() {
if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
// Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Firebase
if (window.currentUser) {
window.remove(window.ref(window.db, `locations/${window.currentUser.uid}`));
}

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Firebase
window.auth.signOut().then(() => {
// Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
localStorage.removeItem('driverData');
localStorage.removeItem('passengerData');
localStorage.removeItem('selectedRole');

// Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
window.currentUser = null;
window.currentRole = null;
currentLocation = null;
selectedDriver = null;
currentTrip = null;
currentTripRequestId = null;

// Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©
if (currentMap) {
currentMap.remove();
currentMap = null;
}

// Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
showPage('loginPage');
}).catch((error) => {
console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬:", error);
alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");
});
}
}

// Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
document.addEventListener('DOMContentLoaded', function() {
const chatInput = document.getElementById('chatInput');
if (chatInput) {
chatInput.addEventListener('keypress', function(e) {
if (e.key === 'Enter') {
sendMessage();
}
});
}
});

// Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„Ù„Ø£Ø­Ø¯Ø§Ø«
document.addEventListener('DOMContentLoaded', function() {
// Ù…Ø³ØªÙ…Ø¹ Ù„ØªØºÙŠÙŠØ± Ù…Ù„ÙØ§Øª Ø§Ù„Ù‡ÙˆÙŠØ©
const passengerIdCard = document.getElementById('passengerIdCard');
if (passengerIdCard) {
passengerIdCard.addEventListener('change', function() {
const label = document.querySelector('label[for="passengerIdCard"]');
if (label && this.files.length > 0) {
label.textContent = `âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: ${this.files[0].name}`;
label.style.borderColor = '#48bb78';
label.style.background = '#f0fff4';
}
});
}

const driverId = document.getElementById('driverId');
if (driverId) {
driverId.addEventListener('change', function() {
const label = document.querySelector('label[for="driverId"]');
if (label && this.files.length > 0) {
label.textContent = `âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: ${this.files[0].name}`;
label.style.borderColor = '#48bb78';
label.style.background = '#f0fff4';
}
});
}

const carCheck = document.getElementById('carCheck');
if (carCheck) {
carCheck.addEventListener('change', function() {
const label = document.querySelector('label[for="carCheck"]');
if (label && this.files.length > 0) {
label.textContent = `âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: ${this.files[0].name}`;
label.style.borderColor = '#48bb78';
label.style.background = '#f0fff4';
}
});
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
const phoneInputs = document.querySelectorAll('input[type="tel"]');
phoneInputs.forEach(input => {
input.addEventListener('input', function() {
const phoneRegex = /^(06|07)[0-9]{8}$/;
if (this.value && !phoneRegex.test(this.value)) {
this.style.borderColor = '#e53e3e';
} else {
this.style.borderColor = '#48bb78';
}
});
});

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©
const plateInput = document.getElementById('plateNumber');
if (plateInput) {
plateInput.addEventListener('input', function() {
// ØªÙ†Ø³ÙŠÙ‚ Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØºØ±Ø¨ÙŠØ©
this.value = this.value.toUpperCase();
});
}
});

// Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
function checkConnection() {
if (!navigator.onLine) {
showNotification('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'error');
return false;
}
return true;
}

// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
window.addEventListener('online', function() {
showNotification('âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„', 'ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
});

window.addEventListener('offline', function() {
showNotification('âš ï¸ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„', 'ØªÙ… ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'error');
});

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ù„ÙŠ
function updateLocalTime() {
const now = new Date();
const timeString = now.toLocaleString('ar-MA', {
timeZone: 'Africa/Casablanca',
year: 'numeric',
month: '2-digit',
day: '2-digit',
hour: '2-digit',
minute: '2-digit'
});
return timeString;
}

// Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ø±Ø­Ù„Ø§Øª
function saveTripHistory(tripData) {
if (!window.currentUser) return;

const historyRef = window.ref(window.db, `tripHistory/${window.currentUser.uid}`);
window.push(historyRef, {
...tripData,
completedAt: Date.now(),
localTime: updateLocalTime()
});
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø±Ø­Ù„Ø§Øª
function showTripHistory() {
if (!window.currentUser) return;

const historyRef = window.ref(window.db, `tripHistory/${window.currentUser.uid}`);
window.get(historyRef).then((snapshot) => {
if (snapshot.exists()) {
const trips = snapshot.val();
console.log('Ø³Ø¬Ù„ Ø§Ù„Ø±Ø­Ù„Ø§Øª:', trips);
// ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ø¬Ù‡Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„ Ù‡Ù†Ø§
}
});
}

// Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
function calculateUserRating(userId) {
const ratingsRef = window.ref(window.db, `ratings/${userId}`);
return window.get(ratingsRef).then((snapshot) => {
if (snapshot.exists()) {
const ratings = snapshot.val();
const values = Object.values(ratings);
const average = values.reduce((sum, rating) => sum + rating.score, 0) / values.length;
return Math.round(average * 10) / 10; // ØªÙ‚Ø±ÙŠØ¨ Ù„Ø±Ù‚Ù… Ø¹Ø´Ø±ÙŠ ÙˆØ§Ø­Ø¯
}
return 0;
});
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¶Ø§ÙØ© ØªÙ‚ÙŠÙŠÙ…
function addRating(targetUserId, score, comment) {
if (!window.currentUser || score < 1 || score > 5) return;

const ratingData = {
fromUserId: window.currentUser.uid,
fromUserName: window.currentUser.displayName,
score: score,
comment: comment || '',
timestamp: Date.now()
};

window.push(window.ref(window.db, `ratings/${targetUserId}`), ratingData);
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª push (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø¯Ø¹ÙˆÙ…Ø©)
function sendPushNotification(title, body) {
if ('Notification' in window && Notification.permission === 'granted') {
new Notification(title, {
body: body,
icon: '/favicon.ico',
badge: '/favicon.ico'
});
}
}

// Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
function requestNotificationPermission() {
if ('Notification' in window && Notification.permission === 'default') {
Notification.requestPermission().then(permission => {
if (permission === 'granted') {
console.log('ØªÙ… Ù…Ù†Ø­ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª');
}
});
}
}

// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù† Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
requestNotificationPermission();
});

// Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
function saveSettings(settings) {
if (!window.currentUser) return;

window.update(window.ref(window.db, `userSettings/${window.currentUser.uid}`), settings);
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
function loadSettings() {
if (!window.currentUser) return Promise.resolve({});

return window.get(window.ref(window.db, `userSettings/${window.currentUser.uid}`))
.then(snapshot => snapshot.exists() ? snapshot.val() : {});
}

// Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function validateInput(input, type) {
switch(type) {
case 'phone':
return /^(06|07)[0-9]{8}$/.test(input);
case 'name':
return input.length >= 2 && /^[\u0600-\u06FF\s]+$/.test(input);
case 'plateNumber':
return input.length >= 4 && input.length <= 10;
default:
return input.length > 0;
}
}

// Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
function cleanupOldData() {
const oneHourAgo = Date.now() - (60 * 60 * 1000);

// ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
const locationsRef = window.ref(window.db, 'locations');
window.get(locationsRef).then(snapshot => {
if (snapshot.exists()) {
const locations = snapshot.val();
Object.keys(locations).forEach(userId => {
if (locations[userId].timestamp < oneHourAgo) {
window.remove(window.ref(window.db, `locations/${userId}`));
}
});
}
});
}

// ØªØ´ØºÙŠÙ„ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ Ø³Ø§Ø¹Ø©
setInterval(cleanupOldData, 60 * 60 * 1000);

// Ø¯Ø§Ù„Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…Ø©
function handleError(error, context) {
console.error(`Ø®Ø·Ø£ ÙÙŠ ${context}:`, error);

let message = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹';

if (error.code) {
switch(error.code) {
case 'auth/network-request-failed':
message = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„';
break;
case 'auth/too-many-requests':
message = 'ØªÙ… ØªØ¬Ø§ÙˆØ² Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹';
break;
default:
message = error.message || message;
}
}
showNotification('Ø®Ø·Ø£', message, 'error');
}

// Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ù„Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…Ø©
window.addEventListener('error', function(e) {
handleError(e.error, 'Ø§Ù„Ù†Ø¸Ø§Ù…');
});

// Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ù„Ù„ÙˆØ¹ÙˆØ¯ Ø§Ù„Ù…Ø±ÙÙˆØ¶Ø©
window.addEventListener('unhandledrejection', function(e) {
handleError(e.reason, 'Promise');
e.preventDefault();
});

console.log('ğŸš— ØªÙ… ØªØ­Ù…ÙŠÙ„ ØªØ·Ø¨ÙŠÙ‚ GRASIAS Ø¨Ù†Ø¬Ø§Ø­');
</script>
</body>
</html>


